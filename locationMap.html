<script src="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.css" rel="stylesheet" />

<style>

	.slx-marker {
		background-image: url("https://uploads-ssl.webflow.com/5e0cc5b73f3d9576faa5719a/5e4fc0527fa93b7c3adc616a_SLX%20Map%20Marker.svg");
		background-position: center;
		background-repeat: no-repeat;
		background-size: contain;
		width: 4rem;
		height: 4rem;
	}

	.map-marker {
		background-color: white;
		width: 0.75rem;
		height: 0.75rem;
		border-radius: 50%;
		cursor: pointer;
	}

</style>

<script>

	const mapCats = document.getElementsByClassName("map-category");
	const mapItems = document.getElementsByClassName("map-item");
	const slxMarker = {type: "FeatureCollection", features: [{type: "Feature", geometry: {type: "Point", coordinates: [-84.309, 33.891]}}]}
	var geojson = {type: "FeatureCollection", features: []}
	var markers = [];

	// Crete new map
	mapboxgl.accessToken = "pk.eyJ1IjoidGhlY2hyaXNlbHNvbiIsImEiOiJjazY2aWMwYW4wNHN3M2xwajVwdXg5bnZwIn0.qN17abkQA21Ry6Bu2PbMBA";
	var map = new mapboxgl.Map({
		container: "mapContainer",
		style: "mapbox://styles/thechriselson/ck6uy74br02al1io4dynodeq8",
		center: [-84.309, 33.891],
		zoom: 14
	});

	// Open/Close category lists
	function openCloseCat(cat) {
		for(let i = 0; i < mapCats.length; i++) {
			let maxH = "" + Number(getComputedStyle(mapItems[0]).height.replace(/[^\d\.-]/g, '') * listNum / 16 + "rem";
			if(mapCats[i].textContent == cat) {
				// Open list
				mapCats[i].style.maxHeight = maxH;
				mapCats[i].style.paddingBottom = "0.875em"
			}
			else {
				// Close list
				mapCats[i].style.transition = "all 0ms";
				mapCats[i].style.maxHeight = maxH;
				mapCats[i].style.transition = "all 400ms";
				mapCats[i].style.paddingBottom = "0em";
				mapCats[i].style.maxHeight = "0rem"
			}
		}
	}

	// Filter markers
	function filterMarkers(cat) {
		for(let i = 0; i < markers.length; i++) {
			if(cat == "All") {markers[i].style.display = "block"}
			else if(markers[i].dataset.cat != cat) {markers[i].style.display = "none"}
			else {markers[i].stye.display = "block"}
		}
	}

	// Create new marker
	function createMarker(marker, className, popup) {
		let el = document.createElement('div');
		el.className = className;
		if(popup) {
			new mapboxgl.Marker(el)
				.setLngLat(marker.geometry.coordinates)
				.setPopup(new mapboxgl.Popup({offset: 25})
					.setHTML('<p>' + marker.properties.title + '</p>'))
				.addTo(map);
			// Set color + assign category data to new element + push to array
			el.style.backgroundColor = marker.color;
			el.setAttribute('data-cat', marker.category);
			el.style.transition = "all 400ms";
			// Sort into markers[] by category
			if(markers.length == 0) {markers.push({marker.category: [el]})}
			else {
				let newCat = true;
				for(let i = 0; i < markers.length; i++) {
					if(marker.category == markers[i]) {markers[i].push(el); newCat = false; break}
				}
				if(newCat == true) {markers.push({marker.category: [el]})}
			}
			//markers.push(el)
			}
		else {new mapboxgl.Marker(el).setLngLat(marker.geometry.coordinates).addTo(map)}
	}

	// Collect data from map items + push to geojson[] as marker object
	for(let i = 0; i < mapItems.length; i++) {
		let data = mapItems[i].querySelector(".map-item-embed").dataset;
		geojson.features.push({
			type: "Feature",
			geometry: {
				type: "Point",
				coordinates: [data.lng, data.lat]
			},
			properties: {
				title: data.name
			},
			category: data.cat,
			color: data.color,
		});
	}

	// Create SLX marker
	createMarker(slxMarker.features[0], "slx-marker", false);

	// Create all location markers
	for(let i = 0; i < geojson.features.length; i++) {createMarker(geojson.features[i], "map-marker", true)}

	// Category names onClick
	for(let i = 0; i < mapCats.length; i++) {
		mapCats[i].addEventListener('click', function() {
			// Expand items list + filter markers
			openCloseCat(mapCats[i].textContent);
			filterMarkers(mapCats[i].textContent)
		})
	}

</script>